# Momentia 開発ロードマップ

このロードマップは、Momentia 写真ポートフォリオプロジェクトの主要な開発マイルストーンを示しています。異なる開発セッションや複数の貢献者間での継続性と明確さを確保するためのガイドとして機能します。このロードマップに従うことで、スケーラビリティ、使いやすさ、最新技術との統合に重点を置きながら、プラットフォームを体系的に構築、強化、維持することを目指します。

## 短期目標（1～2ヶ月）

- ✅ Next.js プロジェクト構造と初期設定のセットアップ。
- ✅ Azure Blob Storage を写真のアップロードと保存に統合。
- ✅ ドラッグ＆ドロップ機能を備えた画像アップロードUIの実装。
- ✅ ページネーション付きの基本的な写真ギャラリー表示の開発。
- ✅ 写真メタデータを保存するための PostgreSQL データベーススキーマの設定。
- ✅ Next.js で写真メタデータの CRUD 操作用 API ルートの作成。
- ✅ ユーザー認証と認可の実装。
- ✅ Azure への自動デプロイのための CI/CD パイプラインの確立。
- ✅ コアコンポーネントと API エンドポイントの単体テスト作成。
- ✅ Azure Container Apps へのデプロイ。
- ✅ カスタムドメイン（www.momentia.photo）の設定完了。
- ブログ画像アップロード用の別の Blob コンテナの有効化。
- ✅ MVP 購入フローの Stripe Checkout（ホスト型ページ）対応完了。単一アイテムの「今すぐ購入」から開始し、後にカート機能拡張予定。
- ✅ 注文ステータス管理の実装完了。
- デジタル商品のダウンロードリンク機能（Webhook → Success ページで表示）。
- 問い合わせフォームの実装。
- プリント販売は「近日公開」とし、FUJIFILM WALLDECOR または国内ラボパートナーによる額装プリントのフルフィルメントを評価。
- FUJIFILM のビジネス利用申請を提出（カスタムドメイン設定後に実施）。
- Blob のオリジナルをプライベートにロックダウンし、短期間有効な SAS またはサーバーストリーミングで画像を提供。サムネイルはキャッシュ可能に維持。
- ライトボックスプレビュー用の基本的なウォーターマークを追加（サーバーサイド、環境変数で調整可能）。

## 中期目標（3～6ヶ月）

- フィルタリングおよびソート機能を備えた写真ギャラリーの強化。
- Azure Cognitive Services を用いたアップロード写真の AI ベースのキャプションおよびキーワード生成の統合。
- クロッピングやリサイズなどの写真編集機能の実装。
- ユーザープロファイル管理とパーソナライズされたギャラリーの追加。
- Next.js の Image コンポーネントと Azure CDN を使用した画像読み込みの最適化。
  - 2025-10: `next/image` + PhotoAlbum の列レイアウト最適化を試行したが、望む多列表示が維持できずロールバック。
- 写真ビュー数およびユーザーエンゲージメントを追跡する分析ダッシュボードの開発。
- 役割ベースのアクセス制御およびデータ検証によるセキュリティの強化。
- パフォーマンステストの実施とデータベースクエリの最適化。
- 統合テストおよびエンドツーエンドテストによるテストカバレッジの拡大。
- 代替決済手段としての PayPal の追加。Amazon Pay はローンチ後に評価予定。
- セキュリティ強化：CSP ハードニング、API レートリミット、アップロードサイズ制限の導入。基本的な WAF ルールの追加。

## 長期目標（6ヶ月以上）

- 共有アルバムやコメントなどのコラボレーション機能の導入。
- 自動写真タグ付けやコンテンツモデレーションなどの高度な AI 機能の実装。
- オフラインアクセス対応のモバイルアプリ統合または PWA サポートの開発。
- 大規模ユーザーベースおよび高トラフィックをサポートするためのインフラ拡張。
- バックアップおよび災害復旧のための他クラウドサービスとの統合。
- ユーザーフィードバックやユーザビリティ調査に基づく UI/UX の継続的更新。
- プレミアムアカウントやプリントサービスなどの収益化オプションの検討。
- 開発者およびユーザー向けの包括的なドキュメントの維持。
- 定期的なセキュリティ監査およびコンプライアンスチェックの計画と実施。

## デプロイ＆運用チェックリスト

### デプロイ＆運用チェックリスト

> **注意:** 公開リリースのために Azure にデプロイする際は、オリジナルの Blob ストレージコンテナをプライベートに設定し、API または短期間有効な SAS 経由で提供してください。

#### Azure & Entra ID セットアップ
1. **Entra ID リダイレクト URI**
   - 本番 URL を追加：
     ```
     https://www.momentia.photo/api/auth/callback/azure-ad
     ```
   - ステージング（必要な場合）：
     ```
     https://momentia.delightfulisland-cc05cb09.japaneast.azurecontainerapps.io/api/auth/callback/azure-ad
     ```
   - ローカル開発用 URI は維持：
     ```
     http://localhost:3000/api/auth/callback/azure-ad
     ```
   - カスタムドメインを使用する場合は、追加のリダイレクト URI として Entra ID に登録。

2. **環境変数**
   - `NEXTAUTH_URL` → 本番 URL に設定。
   - `AZURE_AD_CLIENT_ID`、`AZURE_AD_CLIENT_SECRET`、`AZURE_AD_TENANT_ID` → Azure ポータルの値に合わせる。
   - `AZURE_STORAGE_CONNECTION_STRING` → 本番ストレージアカウントの接続文字列を使用。
   - `DATABASE_URL` → 本番 PostgreSQL インスタンスを指す。

3. **Azure Container Apps 設定**
   - 必要なすべての環境変数を Container Apps 設定にセット。
   - デプロイメントスロット（ステージング／本番）を使用する場合は両方設定。

4. **セキュリティチェック**
   - 必要な箇所で役割ベースアクセス制御が有効になっていることを確認。
   - 管理ページが認証の背後にあることを検証。
   - 開発／テストアカウントを削除。

5. **決済（MVP – Stripe Checkout）**
   - Stripe ダッシュボードで **Product** と **Price** を作成（JPY）。
   - サーバールート：`/api/checkout/create` → 成功／キャンセル URL 付きの Checkout セッションを作成。
   - Webhook：`checkout.session.completed` を処理 → 注文を支払い済みにマークし、ライセンス／ダウンロード用 SAS を発行、領収書メール送信。
   - 環境変数：`STRIPE_SECRET_KEY`、`STRIPE_WEBHOOK_SECRET`、`NEXT_PUBLIC_STRIPE_PUBKEY`。
   - Test cards を用いた本番前テスト（3Dセキュア含む）。

6. **最終確認**
   - 本番環境で認証フローをテスト。
   - 画像アップロードとギャラリー表示を検証。
   - CDN キャッシュが期待通りに機能することを確認。

7. **運用前手続き**
   - FUJIFILM（WALLDECOR 等）のビジネス利用申請を提出（カスタムドメイン URL を記載）。

---

_このチェックリストはスムーズなデプロイを支援し、設定ミスを最小限に抑えます。_

_最終更新日: 2025-10-14_
